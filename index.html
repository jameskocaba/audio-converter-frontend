const urlInput = document.getElementById('urlInput');
const convertBtn = document.getElementById('convertBtn');
const status = document.getElementById('status');
const errorDiv = document.getElementById('errorMessage');
const warningBox = document.getElementById('warningBox');
const warningContent = document.getElementById('warningContent');
const downloadArea = document.getElementById('downloadArea');
const downloadList = document.getElementById('downloadList');

// Paste functionality
document.getElementById('pasteBtn').addEventListener('click', async () => {
    try {
        const text = await navigator.clipboard.readText();
        urlInput.value = text;
    } catch (err) {
        console.error('Failed to read clipboard');
    }
});

convertBtn.addEventListener('click', async () => {
    const url = urlInput.value.trim();
    
    if (!url) {
        errorDiv.innerText = "Please paste a link first.";
        errorDiv.style.display = 'block';
        return;
    }

    // Reset UI for new request
    errorDiv.style.display = 'none';
    warningBox.style.display = 'none';
    status.innerText = "Processing...";
    downloadList.innerHTML = "";
    downloadArea.classList.add('hidden');
    
    try {
        const response = await fetch('/convert', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url: url })
        });

        const data = await response.json();

        // Check if the server returned a 400 (Invalid Link) or 500 (Server Error)
        if (!response.ok) {
            errorDiv.innerText = data.message || "Invalid request.";
            errorDiv.style.display = 'block';
            status.innerText = "Ready";
            return;
        }

        // If we get here, the request was successful
        status.innerText = "Conversion Complete!";
        downloadArea.classList.remove('hidden');

        // 1. Handle ZIP
        if (data.zipLink) {
            const li = document.createElement('li');
            li.innerHTML = `<a href="${data.zipLink}" style="font-weight:bold; color: #2e7d32;">üéÅ Download All (ZIP)</a>`;
            downloadList.appendChild(li);
        }

        // 2. Handle Individual Tracks
        if (data.tracks && data.tracks.length > 0) {
            data.tracks.forEach(track => {
                const li = document.createElement('li');
                li.innerHTML = `<a href="${track.downloadLink}">${track.name}</a>`;
                downloadList.appendChild(li);
            });
        }

        // 3. Handle Skipped Tracks (Orange Box)
        if (data.skipped && data.skipped.length > 0) {
            warningBox.style.display = 'block';
            let listHtml = "The following tracks were skipped (artist restrictions):<ul>";
            data.skipped.forEach(t => listHtml += `<li>${t}</li>`);
            listHtml += "</ul>";
            warningContent.innerHTML = listHtml;
        }

    } catch (err) {
        // This only triggers if the server is literally DOWN (Network Error)
        console.error("Fetch error:", err);
        status.innerText = "Ready";
    }
});